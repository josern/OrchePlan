#!/bin/bash

# Script to safely remove vulnerable validator.js dependency
# and transition to secure validation implementation

echo "üîí OrchePlan Security Fix: Removing Vulnerable Validator.js Dependency"
echo "======================================================================"

# Step 1: Backup current package.json
echo "üìã Step 1: Creating backup of package.json..."
cp package.json package.json.backup
echo "‚úÖ Backup created: package.json.backup"

# Step 2: Check current vulnerabilities
echo ""
echo "üìä Step 2: Current vulnerability status..."
npm audit --audit-level=moderate

# Step 3: Test current validation (optional - requires tests)
echo ""
echo "üß™ Step 3: Testing current validation (if tests exist)..."
if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
    npm test 2>/dev/null || echo "‚ö†Ô∏è  Tests not available or failing - proceeding with manual verification"
else
    echo "‚ÑπÔ∏è  No test script found - manual verification recommended"
fi

# Step 4: Install secure alternatives
echo ""
echo "üì¶ Step 4: Installing secure validation alternatives..."
npm install joi zod --save

# Step 5: Optional - Remove express-validator (commented out for safety)
echo ""
echo "‚ö†Ô∏è  Step 5: Express-validator removal (manual step required)"
echo "To complete the security fix, manually run:"
echo "npm uninstall express-validator"
echo ""
echo "‚ö†Ô∏è  IMPORTANT: Only do this after updating all validation code!"

# Step 6: Security verification
echo ""
echo "üîç Step 6: Post-installation security check..."
npm audit --audit-level=moderate

echo ""
echo "üìã Next Steps:"
echo "=============="
echo "1. Update validation middleware to use secure functions"
echo "2. Test all validation endpoints manually"
echo "3. Run: npm uninstall express-validator (when ready)"
echo "4. Verify no remaining validator.js references"
echo "5. Run security audit again"

echo ""
echo "üìÅ Files created for secure validation:"
echo "- src/utils/secureValidation.ts"
echo "- src/middleware/secureValidation.ts" 

echo ""
echo "üîí Security Fix Summary:"
echo "========================"
echo "Issue: CVE-2025-56200 - validator.js URL validation bypass"
echo "Impact: XSS and Open Redirect attacks possible"
echo "Solution: Custom secure validation functions"
echo "Status: Partial - requires validation code updates"

echo ""
echo "‚úÖ Security improvement script completed!"
echo "‚ö†Ô∏è  Manual validation code updates still required"